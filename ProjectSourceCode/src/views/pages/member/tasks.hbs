<div class="tasks-page">
    <div class="container-fluid px-4">
        <div class="row g-4">

            <div class="col-md-6">
                <div class="tasks-card">
                    <div class="login-card-body">
                        <h3>Tasks for {{user.display_name}}</h3>

                        <div class="tasks">
                            {{#if tasks}}
                                {{#if tasks.length}}
                                    {{#each tasks}}
                                        <div class="row border rounded m-1 py-2 px-2" data-task-id="{{this.id}}" style="{{#if this.completed_at}}background-color: #e8f5e9; opacity: 0.7;{{/if}}">
                                            <div class="col-8">
                                                <strong>{{this.title}}</strong><br>
                                                Points: {{this.story_points}}
                                            </div>
                                            <div class="col-4 text-end">
                                                {{#if this.completed_at}}
                                                    <span style="color: green;">✓ Completed</span>
                                                {{else}}
                                                    <button class="btn btn-sm btn-success complete-task-btn" data-task-id="{{this.id}}">Complete</button>
                                                {{/if}}
                                            </div>
                                        </div>
                                    {{/each}}
                                {{else}}
                                    <p>No tasks assigned.</p>
                                {{/if}}
                            {{else}}
                                <p>No tasks assigned.</p>
                            {{/if}}
                        </div>

                    </div>
                </div>
            </div>

            <!-- Points Overview -->
            <div class="col-md-6">
                <div class="tasks-card">
                    <div class="login-card-body">
                        <h3>Points Overview</h3>
                        <p id="pointsDisplay">Current Points: {{user.total_points}}</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const completeButtons = document.querySelectorAll('.complete-task-btn');
        
        completeButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                const taskId = button.getAttribute('data-task-id');
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                
                try {
                    const response = await fetch(`/tasks/${taskId}/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        alert(`Failed: ${error.message || 'Unknown error'}`);
                        return;
                    }
                    
                    const result = await response.json();
                    
                    // Update the task element to show completed status
                    taskElement.style.backgroundColor = '#e8f5e9';
                    taskElement.style.opacity = '0.7';
                    
                    // Replace button with completion message
                    const buttonCol = button.parentElement;
                    buttonCol.innerHTML = '<span style="color: green;">✓ Completed</span>';
                    
                    // Move to bottom
                    const tasksContainer = taskElement.parentElement;
                    tasksContainer.appendChild(taskElement);
                    
                    // Update points display
                    const pointsDisplay = document.getElementById('pointsDisplay');
                    pointsDisplay.textContent = `Current Points: ${result.newTotalPoints}`;
                    
                    alert('Task completed and points earned!');
                } catch (err) {
                    console.error('Error:', err);
                    alert('Failed to complete task');
                }
            });
        });
    });
</script>