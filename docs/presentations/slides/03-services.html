<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gello Code Tour - Services</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/theme/black.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/monokai.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../assets/css/gello.css">
</head>
<body>
  <!-- Back to Index Button -->
  <a href="../index.html" class="nav-home" title="Back to Tours" aria-label="Back to tour index">
    <i class="bi bi-house-fill"></i>
  </a>

  <!-- Breadcrumb Navigation -->
  <nav class="slide-breadcrumb" aria-label="Breadcrumb">
    <a href="../index.html">Tours</a>
    <span class="separator">→</span>
    <span class="current">Services</span>
  </nav>

  <!-- Progress Bar -->
  <div class="slide-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    <div class="slide-progress-bar"></div>
  </div>
  <span class="slide-progress-text" aria-live="polite">1 / 7</span>

  <div class="reveal">
    <div class="slides">
      <section class="title-slide">
        <h1>Services Tour</h1>
        <p class="subtitle">Gello Codebase Tour - Part 3</p>
        <p class="muted">Core business services and their responsibilities</p>
        <aside class="notes">This module covers the services that contain Gello's business logic.</aside>
      </section>

      <section>
        <h2>Service Inventory</h2>
        <div class="columns">
          <div>
            <table style="font-size: 0.75em;">
              <tr class="fragment"><td><code>auth.service</code></td><td>Authentication, sessions</td></tr>
              <tr class="fragment"><td><code>board.service</code></td><td>Board CRUD + team context</td></tr>
              <tr class="fragment"><td><code>list.service</code></td><td>List management</td></tr>
            </table>
          </div>
          <div>
            <table style="font-size: 0.75em;">
              <tr class="fragment"><td><code>task.service</code></td><td>Task ops + points</td></tr>
              <tr class="fragment"><td><code>points.service</code></td><td>Gamification</td></tr>
              <tr class="fragment"><td><code>leaderboard.service</code></td><td>Rankings</td></tr>
            </table>
          </div>
        </div>
        <p class="fragment muted" style="margin-top: 1rem;">Each service handles a specific domain with single responsibility</p>
        <aside class="notes">6 core services covering authentication, boards, tasks, and gamification.</aside>
      </section>

      <section>
        <h2>Auth Service + Flow</h2>
        <pre><code class="language-typescript">// lib/services/auth.service.ts
export class AuthService {
  async login(email: string, password: string) {
    const { data, error } = await this.supabase.auth
      .signInWithPassword({ email, password });
    if (error) throw new UnauthorizedError(error.message);
    return data.user;
  }

  async getCurrentUser() {
    const { data: { user } } = await this.supabase.auth.getUser();
    return user;
  }
}</code></pre>
        <div class="flow fragment" style="margin-top: 1rem; font-size: 0.8em;">
          <div class="flow-box">Login Form</div>
          <span class="flow-arrow">→</span>
          <div class="flow-box">Auth Route</div>
          <span class="flow-arrow">→</span>
          <div class="flow-box">Auth Service</div>
          <span class="flow-arrow">→</span>
          <div class="flow-box">Supabase Auth</div>
        </div>
        <p class="fragment muted">Session stored in httpOnly cookie for SSR compatibility</p>
        <aside class="notes">Auth service wraps Supabase Auth. Sessions are cookie-based.</aside>
      </section>

      <section>
        <h2>Task + Points Integration</h2>
        <pre><code class="language-typescript">// lib/services/task.service.ts - The gamification hook
export class TaskService {
  async completeTask(taskId: string) {
    const task = await this.db.markComplete(taskId);

    // Award points on completion (gamification)
    if (task.points_value > 0) {
      await this.pointsService.awardPoints(
        task.assigned_to, task.points_value, 'task_completion'
      );
    }
    return task;
  }
}

// lib/services/points.service.ts
async awardPoints(userId: string, amount: number, reason: string) {
  await this.db.createHistory({ user_id: userId, amount, reason, awarded_at: new Date() });
  await this.db.incrementUserPoints(userId, amount);
}</code></pre>
        <aside class="notes">Task completion triggers points award - this is the core gamification mechanism.</aside>
      </section>

      <section>
        <h2>Board + Leaderboard</h2>
        <div class="columns">
          <div>
            <h3 style="font-size: 1em;">Board Service</h3>
            <pre><code class="language-typescript" style="font-size: 0.7em;">async createBoard(data: CreateBoardInput) {
  // Validate team membership
  await this.validateTeamMembership(data.teamId);
  return this.db.create({
    ...data,
    created_by: this.userId,
  });
}</code></pre>
          </div>
          <div>
            <h3 style="font-size: 1em;">Leaderboard Service</h3>
            <pre><code class="language-typescript" style="font-size: 0.7em;">async getTeamLeaderboard(teamId: string) {
  const members = await this.db.getTeamMembers(teamId);
  const rankings = await Promise.all(
    members.map(async (m) => ({
      user: m,
      points: await this.pointsDb.getTotalPoints(m.id),
    }))
  );
  return rankings.sort((a, b) => b.points - a.points);
}</code></pre>
          </div>
        </div>
        <aside class="notes">Board service enforces team membership. Leaderboard aggregates points per team member.</aside>
      </section>

      <section>
        <h2>Service Patterns</h2>
        <div class="columns">
          <div>
            <ul>
              <li class="fragment"><span class="accent">Constructor injection</span><br><span class="muted">Dependencies passed in</span></li>
              <li class="fragment"><span class="accent">Single responsibility</span><br><span class="muted">One domain per service</span></li>
            </ul>
          </div>
          <div>
            <ul>
              <li class="fragment"><span class="accent">Validation first</span><br><span class="muted">Check permissions before ops</span></li>
              <li class="fragment"><span class="accent">Composition</span><br><span class="muted">Services call other services</span></li>
            </ul>
          </div>
        </div>
        <pre class="fragment"><code class="language-typescript" style="font-size: 0.75em;">// Unit testing with mocked dependencies
const mockDb = { markComplete: vi.fn() };
const mockPoints = { awardPoints: vi.fn() };
const service = new TaskService(mockDb, mockPoints);
await service.completeTask('task-1');
expect(mockPoints.awardPoints).toHaveBeenCalled();</code></pre>
        <aside class="notes">These patterns keep services testable and focused. Easy to unit test with mocks.</aside>
      </section>

      <section>
        <h2>Summary</h2>
        <ul>
          <li class="fragment"><span class="accent">6 core services:</span> Auth, Board, List, Task, Points, Leaderboard</li>
          <li class="fragment"><span class="accent">Auth:</span> Wraps Supabase Auth with cookie sessions</li>
          <li class="fragment"><span class="accent">Gamification:</span> Task completion → Points → Leaderboard</li>
          <li class="fragment"><span class="accent">Patterns:</span> DI, single responsibility, validation first</li>
        </ul>
        <p class="fragment" style="margin-top: 2rem;">
          <a href="02-architecture.html">← Previous</a> · <a href="../index.html">Index</a> · <a href="04-database.html">Next: Database →</a>
        </p>
        <aside class="notes">Services contain business logic and are testable via dependency injection.</aside>
      </section>
    </div>
  </div>

  <!-- Completion Overlay -->
  <div class="completion-overlay" id="completion-overlay" style="display: none;">
    <h3><i class="bi bi-check-circle-fill me-2"></i>Tour Complete</h3>
    <p>You've finished the Services tour</p>
    <div class="actions">
      <a href="04-database.html" class="btn btn-primary">Next: Database →</a>
      <a href="../index.html" class="btn btn-secondary">Back to Index</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/highlight.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/notes/notes.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/motion@11.18.0/dist/motion.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="../assets/js/tour-progress.js"></script>
  <script src="../assets/js/confetti-setup.js"></script>
  <script src="../assets/js/motion-setup.js"></script>
  <script>
    const TOUR_ID = '03-services';
    const NEXT_TOUR = { id: '04-database', name: 'Database Layer', url: '04-database.html' };

    Reveal.initialize({
      hash: true,
      slideNumber: false,
      progress: false,
      history: true,
      plugins: [RevealHighlight, RevealNotes]
    });

    Reveal.on('slidechanged', () => {
      const current = Reveal.getIndices().h + 1;
      const total = Reveal.getTotalSlides();
      const percent = (current / total) * 100;
      const progressBar = document.querySelector('.slide-progress-bar');
      const progressText = document.querySelector('.slide-progress-text');
      if (progressBar) {
        if (window.Motion && !window.GelloMotion?.prefersReducedMotion) {
          window.Motion.animate(progressBar, { width: `${percent}%` }, { duration: 0.35, easing: [0.4, 0, 0.2, 1] });
        } else {
          progressBar.style.width = `${percent}%`;
        }
      }
      if (progressText) progressText.textContent = `${current} / ${total}`;
      if (Reveal.isLastSlide() && !sessionStorage.getItem(`tour-completed-${TOUR_ID}`)) {
        sessionStorage.setItem(`tour-completed-${TOUR_ID}`, 'true');
        handleTourCompletion();
      }
    });

    function handleTourCompletion() {
      const storageKey = 'gello-tour-progress';
      let data = JSON.parse(localStorage.getItem(storageKey) || '{}');
      if (!data.tours) {
        data = { version: 1, tours: { '01-project-overview': { completed: false, lastVisit: null }, '02-architecture': { completed: false, lastVisit: null }, '03-services': { completed: false, lastVisit: null }, '04-database': { completed: false, lastVisit: null }, '05-testing': { completed: false, lastVisit: null } }, allComplete: false };
      }
      const wasAlreadyComplete = data.tours[TOUR_ID]?.completed;
      if (!wasAlreadyComplete) {
        data.tours[TOUR_ID] = { completed: true, lastVisit: new Date().toISOString() };
        data.allComplete = Object.values(data.tours).every(t => t.completed);
        data.lastUpdated = new Date().toISOString();
        localStorage.setItem(storageKey, JSON.stringify(data));
        if (window.GelloConfetti) window.GelloConfetti.tourComplete();
        setTimeout(() => {
          const overlay = document.getElementById('completion-overlay');
          if (overlay) {
            overlay.style.display = 'block';
            if (window.Motion && !window.GelloMotion?.prefersReducedMotion) {
              window.Motion.animate(overlay, { opacity: [0, 1], y: [20, 0] }, { duration: 0.3 });
            }
          }
        }, 1500);
        if (data.allComplete && window.GelloConfetti) setTimeout(() => window.GelloConfetti.allToursComplete(), 2500);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('pre code').forEach(block => {
        const wrapper = block.parentElement;
        wrapper.style.position = 'relative';
        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.innerHTML = '<i class="bi bi-clipboard"></i>';
        button.title = 'Copy to clipboard';
        button.addEventListener('click', async () => {
          await navigator.clipboard.writeText(block.textContent);
          button.innerHTML = '<i class="bi bi-check2"></i>';
          button.classList.add('copied');
          setTimeout(() => { button.innerHTML = '<i class="bi bi-clipboard"></i>'; button.classList.remove('copied'); }, 2000);
        });
        wrapper.appendChild(button);
      });
      const total = Reveal.getTotalSlides();
      document.querySelector('.slide-progress-text').textContent = `1 / ${total}`;
      document.querySelector('.slide-progress-bar').style.width = `${(1/total) * 100}%`;
    });
  </script>
</body>
</html>
