<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gello - Database</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/theme/black.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/monokai.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../assets/css/gello.css">
</head>
<body>
  <!-- Back to Index Button -->
  <a href="../index.html" class="nav-home" title="Back to Presentations" aria-label="Back to presentations index">
    <i class="bi bi-house-fill"></i>
  </a>

  <!-- Breadcrumb Navigation -->
  <nav class="slide-breadcrumb" aria-label="Breadcrumb">
    <a href="../index.html">Presentations</a>
    <span class="separator">→</span>
    <span class="current">Database</span>
  </nav>

  <!-- Progress Bar -->
  <div class="slide-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    <div class="slide-progress-bar"></div>
  </div>
  <span class="slide-progress-text" aria-live="polite">1 / 7</span>

  <div class="reveal">
    <div class="slides">
      <section class="title-slide">
        <h1>Database</h1>
        <p class="subtitle">Gello Codebase - Part 4</p>
        <aside class="notes">Database design, Supabase integration, and RLS policies.</aside>
      </section>

      <section>
        <h2>Why Supabase</h2>
        <div class="columns">
          <div>
            <ul>
              <li class="fragment"><span class="badge badge-success">PostgreSQL</span> Full-featured relational DB</li>
              <li class="fragment"><span class="badge badge-success">Built-in Auth</span> JWT-based sessions</li>
            </ul>
          </div>
          <div>
            <ul>
              <li class="fragment"><span class="badge badge-success">Row Level Security</span> Policy-based access</li>
              <li class="fragment"><span class="badge badge-success">Auto-generated Types</span> Type safety</li>
            </ul>
          </div>
        </div>
        <pre class="fragment"><code class="language-typescript">// lib/supabase.ts - SSR client setup
export function createClient(req: Request, res: Response) {
  return createServerClient(process.env.SUPABASE_URL!, process.env.SUPABASE_ANON_KEY!, {
    cookies: {
      get: (name) => req.cookies[name],
      set: (name, value, options) => { res.cookie(name, value, options); },
    },
  });
}</code></pre>
        <aside class="notes">Supabase provides PostgreSQL with built-in auth and RLS. SSR client syncs cookies with Express.</aside>
      </section>

      <section>
        <h2>Database Module Pattern</h2>
        <div class="columns">
          <div style="font-size: 0.8em;">
            <h3>Modules</h3>
            <ul>
              <li><code>boards.db.ts</code></li>
              <li><code>lists.db.ts</code></li>
              <li><code>tasks.db.ts</code></li>
              <li><code>teams.db.ts</code></li>
              <li><code>users.db.ts</code></li>
              <li><code>points.db.ts</code></li>
            </ul>
          </div>
          <div>
            <pre><code class="language-typescript" style="font-size: 0.7em;">// lib/database/boards.db.ts
export class BoardDb {
  constructor(private supabase: SupabaseClient) {}

  async findById(id: string) {
    const { data, error } = await this.supabase
      .from('boards')
      .select('*')
      .eq('id', id)
      .single();
    if (error) throw new ResourceNotFoundError('Board');
    return data;
  }

  async findByTeam(teamId: string) {
    const { data } = await this.supabase
      .from('boards')
      .select('*')
      .eq('team_id', teamId);
    return data ?? [];
  }
}</code></pre>
          </div>
        </div>
        <p class="fragment muted">One module per table. Simple CRUD wrappers around Supabase queries.</p>
        <aside class="notes">Database modules are simple CRUD wrappers. No business logic here.</aside>
      </section>

      <section>
        <h2>RLS Policy Patterns</h2>
        <pre><code class="language-sql">-- Enable RLS on a table
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

-- Users can only view their own profile
CREATE POLICY "Users view own profile" ON users FOR SELECT
USING (auth.uid() = id);

-- Users can only update their own tasks
CREATE POLICY "Users update own tasks" ON tasks FOR UPDATE
USING (auth.uid() = assigned_to)
WITH CHECK (auth.uid() = assigned_to);

-- Team members can view team boards (subquery pattern)
CREATE POLICY "Team members view boards" ON boards FOR SELECT
USING (EXISTS (
  SELECT 1 FROM team_members
  WHERE team_id = boards.team_id AND user_id = auth.uid()
));</code></pre>
        <p class="fragment muted"><code>auth.uid()</code> returns current user's ID from JWT</p>
        <aside class="notes">RLS policies filter rows based on conditions. USING for reads, WITH CHECK for writes.</aside>
      </section>

      <section>
        <h2>Migrations + Types</h2>
        <div class="columns">
          <div>
            <h3>Migrations</h3>
            <pre><code class="language-bash" style="font-size: 0.8em;"># Create a new migration
bunx supabase migration new add_feature

# Apply migrations locally
bunx supabase db reset

# Check migration status
bunx supabase migration list</code></pre>
            <p class="muted" style="font-size: 0.8em;">Files in <code>supabase/migrations/</code></p>
          </div>
          <div>
            <h3>Type Generation</h3>
            <pre><code class="language-bash" style="font-size: 0.8em;"># Generate types from schema
bun run db:types</code></pre>
            <pre><code class="language-typescript" style="font-size: 0.65em;">// Auto-generated: src/types/database.types.ts
export interface Database {
  public: {
    Tables: {
      tasks: {
        Row: { id: string; title: string; ... }
        Insert: { title: string; ... }
        Update: { title?: string; ... }
      }
    }
  }
}</code></pre>
          </div>
        </div>
        <aside class="notes">Migrations are SQL files with timestamps. Run db:types after schema changes.</aside>
      </section>

      <section>
        <h2>Database Commands</h2>
        <pre><code class="language-bash"># Reset and seed database
bun run start:fresh

# Or just seed
bun run db:seed

# Start/stop Supabase
bun run db:start
bun run db:stop</code></pre>
        <p class="fragment muted">Seed config: <code>supabase/seed/seed.config.ts</code></p>
        <p class="fragment muted">Creates demo users, teams, and sample data for development</p>
        <aside class="notes">Seeding creates demo data. start:fresh is the most common reset command.</aside>
      </section>

      <section>
        <h2>Summary</h2>
        <ul>
          <li class="fragment"><span class="accent">Supabase:</span> PostgreSQL + Auth + RLS in one</li>
          <li class="fragment"><span class="accent">DB Modules:</span> Simple CRUD wrappers per table</li>
          <li class="fragment"><span class="accent">RLS:</span> Access control enforced at database level</li>
          <li class="fragment"><span class="accent">Types:</span> Auto-generated from schema for type safety</li>
        </ul>
        <p class="fragment" style="margin-top: 2rem;">
          <a href="03-services.html">← Previous</a> · <a href="../index.html">Index</a> · <a href="05-testing.html">Next: Testing →</a>
        </p>
        <aside class="notes">Key takeaway: RLS provides security at database level. Types keep TS in sync.</aside>
      </section>
    </div>
  </div>

  <!-- Completion Overlay -->
  <div class="completion-overlay" id="completion-overlay" style="display: none;">
    <h3><i class="bi bi-check-circle-fill me-2"></i>Section Complete</h3>
    <p>You've finished the Database section</p>
    <div class="actions">
      <a href="05-testing.html" class="btn btn-primary">Next: Testing →</a>
      <a href="../index.html" class="btn btn-secondary">Back to Index</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/highlight.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/notes/notes.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/motion@11.18.0/dist/motion.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="../assets/js/progress.js"></script>
  <script src="../assets/js/confetti-setup.js"></script>
  <script src="../assets/js/motion-setup.js"></script>
  <script>
    const SECTION_ID = '04-database';
    const NEXT_SECTION = { id: '05-testing', name: 'Testing', url: '05-testing.html' };

    Reveal.initialize({
      hash: true,
      slideNumber: false,
      progress: false,
      history: true,
      plugins: [RevealHighlight, RevealNotes]
    });

    Reveal.on('slidechanged', () => {
      const current = Reveal.getIndices().h + 1;
      const total = Reveal.getTotalSlides();
      const percent = (current / total) * 100;
      const progressBar = document.querySelector('.slide-progress-bar');
      const progressText = document.querySelector('.slide-progress-text');
      if (progressBar) {
        if (window.Motion && !window.GelloMotion?.prefersReducedMotion) {
          window.Motion.animate(progressBar, { width: `${percent}%` }, { duration: 0.35, easing: [0.4, 0, 0.2, 1] });
        } else {
          progressBar.style.width = `${percent}%`;
        }
      }
      if (progressText) progressText.textContent = `${current} / ${total}`;
      if (Reveal.isLastSlide() && !sessionStorage.getItem(`section-completed-${SECTION_ID}`)) {
        sessionStorage.setItem(`section-completed-${SECTION_ID}`, 'true');
        handleSectionCompletion();
      }
    });

    function handleSectionCompletion() {
      const storageKey = 'gello-slide-progress';
      let data = JSON.parse(localStorage.getItem(storageKey) || '{}');
      if (!data.sections) {
        data = { version: 1, sections: { '01-project-overview': { completed: false, lastVisit: null }, '02-architecture': { completed: false, lastVisit: null }, '03-services': { completed: false, lastVisit: null }, '04-database': { completed: false, lastVisit: null }, '05-testing': { completed: false, lastVisit: null } }, allComplete: false };
      }
      const wasAlreadyComplete = data.sections[SECTION_ID]?.completed;
      if (!wasAlreadyComplete) {
        data.sections[SECTION_ID] = { completed: true, lastVisit: new Date().toISOString() };
        data.allComplete = Object.values(data.sections).every(t => t.completed);
        data.lastUpdated = new Date().toISOString();
        localStorage.setItem(storageKey, JSON.stringify(data));
        if (window.GelloConfetti) window.GelloConfetti.sectionComplete();
        setTimeout(() => {
          const overlay = document.getElementById('completion-overlay');
          if (overlay) {
            overlay.style.display = 'block';
            if (window.Motion && !window.GelloMotion?.prefersReducedMotion) {
              window.Motion.animate(overlay, { opacity: [0, 1], y: [20, 0] }, { duration: 0.3 });
            }
          }
        }, 1500);
        if (data.allComplete && window.GelloConfetti) setTimeout(() => window.GelloConfetti.allSectionsComplete(), 2500);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('pre code').forEach(block => {
        const wrapper = block.parentElement;
        wrapper.style.position = 'relative';
        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.innerHTML = '<i class="bi bi-clipboard"></i>';
        button.title = 'Copy to clipboard';
        button.addEventListener('click', async () => {
          await navigator.clipboard.writeText(block.textContent);
          button.innerHTML = '<i class="bi bi-check2"></i>';
          button.classList.add('copied');
          setTimeout(() => { button.innerHTML = '<i class="bi bi-clipboard"></i>'; button.classList.remove('copied'); }, 2000);
        });
        wrapper.appendChild(button);
      });
      const total = Reveal.getTotalSlides();
      document.querySelector('.slide-progress-text').textContent = `1 / ${total}`;
      document.querySelector('.slide-progress-bar').style.width = `${(1/total) * 100}%`;
    });
  </script>
</body>
</html>
